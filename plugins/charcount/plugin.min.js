/**
 * plugin.js
 *
 * Copyright, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*global tinymce:true */

tinymce.PluginManager.add('charcount', function(editor) {
  var self = this, countre, cleanre;

  countre = editor.getParam('charcount_countregex', /[\w\u2019\x27\-]+/g); // u2019 == &rsquo;
  cleanre = editor.getParam('charcount_cleanregex', /[0-9.(),;:!?%#$?\x27\x22_+=\\\/\-]*/g);

  function update() {
    editor.theme.panel.find('#charcount').text(['Characters: {0}', self.getCount()]);
  }

  editor.on('init', function() {
    var statusbar = editor.theme.panel && editor.theme.panel.find('#statusbar')[0];

    if (statusbar) {
      window.setTimeout(function() {
        statusbar.insert({
          type: 'label',
          name: 'charcount',
          text: ['Characters: {0}', self.getCount()],
          classes: 'wordcount'
        }, 0);

        editor.on('setcontent beforeaddundo', update);

        editor.on('keyup', function(e) {
          if (e.keyCode == 32) {
            update();
          }
        });
      }, 0);
    }
  });

  self.getCount = function() {
    var tx = editor.getContent({format: 'text'}).replace(/\n/g, '');
    var tc = tx.length;

    /*if (tx) {
     tx = tx.replace(/\.\.\./g, ' '); // convert ellipses to spaces
     tx = tx.replace(/<.[^<>]*?>/g, ' ').replace(/&nbsp;|&#160;/gi, ' '); // remove html tags and space chars

     // deal with html entities
     tx = tx.replace(/(\w+)(&.+?;)+(\w+)/, "$1$3").replace(/&.+?;/g, ' ');

     tc = tx.length;
     }*/

    return tc;
  };
});